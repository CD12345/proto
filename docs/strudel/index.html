<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strudel Sketches</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 0% 0%, #f7f7ff, #ededf9 40%, #f6f8ff 70%, #ffffff);
    }
    body {
      margin: 0;
      padding: 24px;
      display: grid;
      gap: 16px;
      max-width: 960px;
    }
    header h1 {
      margin: 0 0 4px;
      letter-spacing: 0.02em;
    }
    header p {
      margin: 0;
      color: #4b5563;
    }
    .panel {
      background: rgba(255,255,255,0.85);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      padding: 16px;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }
    select, button, input[type="range"] {
      font: inherit;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .status {
      font-size: 0.9rem;
      color: #374151;
    }
    pre {
      white-space: pre-wrap;
      background: #0b1221;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
      max-height: 320px;
    }
    .controls button {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid #c7d2fe;
      background: linear-gradient(180deg, #e0e7ff, #c7d2fe);
      cursor: pointer;
    }
    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .meter {
      height: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      position: relative;
      overflow: hidden;
    }
    .meter span {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 0%;
      background: linear-gradient(90deg, #6366f1, #22d3ee);
      transition: width 120ms ease-out;
    }
  </style>
</head>
<body>
  <header>
    <h1>Strudel sketches</h1>
    <p>Load the bundled Strudel runtime, browse the available pieces, and play any movement directly in the browser.</p>
  </header>

  <section class="panel" id="composition-panel">
    <h2>Available compositions</h2>
    <div class="row">
      <label for="composition">Composition</label>
      <select id="composition"></select>
      <label for="movement">Movement</label>
      <select id="movement"></select>
      <span class="status" id="runtime-status">Loading Strudel…</span>
    </div>
    <div class="controls" style="margin-top: 12px;">
      <div class="row" style="gap: 12px;">
        <button id="play">Play</button>
        <button id="pause" disabled>Pause</button>
        <button id="resume" disabled>Resume</button>
        <label class="row" style="gap:6px; align-items:center;">
          Seek
          <input type="range" id="seek" min="0" max="120" step="1" value="0" />
        </label>
      </div>
    </div>
    <div class="meter" style="margin-top: 12px;">
      <span id="progress"></span>
    </div>
  </section>

  <section class="panel">
    <h2>Composition source</h2>
    <pre id="source">Select a composition to view its Strudel source.</pre>
  </section>

  <script type="module">
    const runtimeStatus = document.getElementById('runtime-status');
    const compositionSelect = document.getElementById('composition');
    const movementSelect = document.getElementById('movement');
    const sourceView = document.getElementById('source');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const resumeBtn = document.getElementById('resume');
    const seekSlider = document.getElementById('seek');
    const progressBar = document.getElementById('progress');

    const compositions = [
      {
        id: 'c-sharp-minor-sonata',
        title: 'Sonata in C# minor (after Chopin)',
        file: 'c-sharp-minor-sonata.strudel',
        movements: [
          { id: 'movement1', label: 'Movement I — restless nocturne' },
          { id: 'movement2', label: 'Movement II — singing lento' },
          { id: 'movement3', label: 'Movement III — agitated finale' }
        ]
      }
    ];

    let scheduler;
    let stopCurrent;
    let compositionCache = {};
    let tickInterval;
    let strudel;

    async function loadStrudel() {
      try {
        strudel = await import('./runtime/web/index.mjs');
        const { WebAudioScheduler } = await import('./runtime/webaudio/index.mjs');
        scheduler = new WebAudioScheduler();
        await scheduler.start();
        runtimeStatus.textContent = 'Strudel ready';
      } catch (error) {
        runtimeStatus.textContent = 'Failed to load Strudel runtime';
        console.error('Failed to load Strudel runtime', error);
      }
    }

    function populateCompositions() {
      for (const piece of compositions) {
        const option = document.createElement('option');
        option.value = piece.id;
        option.textContent = piece.title;
        compositionSelect.appendChild(option);
      }
      compositionSelect.value = compositions[0].id;
      populateMovements(compositions[0]);
      fetchSource(compositions[0]);
    }

    function populateMovements(piece) {
      movementSelect.innerHTML = '';
      piece.movements.forEach((movement, index) => {
        const option = document.createElement('option');
        option.value = movement.id;
        option.textContent = movement.label;
        if (index === 0) option.selected = true;
        movementSelect.appendChild(option);
      });
    }

    async function fetchSource(piece) {
      if (compositionCache[piece.id]) {
        sourceView.textContent = compositionCache[piece.id];
        return;
      }
      const res = await fetch(piece.file);
      const text = await res.text();
      compositionCache[piece.id] = text;
      sourceView.textContent = text;
    }

    async function playSelected(seekSeconds = 0) {
      if (!strudel || !scheduler) {
        runtimeStatus.textContent = 'Strudel runtime not available';
        return;
      }
      const piece = compositions.find((p) => p.id === compositionSelect.value);
      if (!piece) return;
      const movement = movementSelect.value;
      const code = `${compositionCache[piece.id]}\nsolo(${movement})`;
      stopPlayback();
      const { evalCode } = strudel;
      if (typeof evalCode !== 'function') {
        runtimeStatus.textContent = 'Strudel runtime missing evalCode';
        return;
      }
      const scheduledAt = scheduler.context.currentTime + 0.05;
      const result = await evalCode(code, { scheduler, start: scheduledAt, seek: seekSeconds });
      stopCurrent = result?.stop ?? null;
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      startTicker();
    }

    function stopPlayback() {
      if (stopCurrent) {
        try { stopCurrent(); } catch (err) { console.warn(err); }
      }
      stopCurrent = null;
      stopTicker();
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
    }

    function pausePlayback() {
      if (scheduler && scheduler.context && typeof scheduler.context.suspend === 'function') {
        scheduler.context.suspend();
        pauseBtn.disabled = true;
        resumeBtn.disabled = false;
      }
    }

    function resumePlayback() {
      if (scheduler && scheduler.context && typeof scheduler.context.resume === 'function') {
        scheduler.context.resume();
        pauseBtn.disabled = false;
        resumeBtn.disabled = true;
      }
    }

    function startTicker() {
      stopTicker();
      tickInterval = setInterval(() => {
        const value = Math.min(parseFloat(seekSlider.value || '0'), parseFloat(seekSlider.max));
        progressBar.style.width = `${(value / seekSlider.max) * 100}%`;
      }, 200);
    }

    function stopTicker() {
      if (tickInterval) {
        clearInterval(tickInterval);
        tickInterval = null;
        progressBar.style.width = '0%';
      }
    }

    compositionSelect.addEventListener('change', async () => {
      const piece = compositions.find((p) => p.id === compositionSelect.value);
      populateMovements(piece);
      await fetchSource(piece);
    });

    movementSelect.addEventListener('change', () => {
      stopPlayback();
    });

    playBtn.addEventListener('click', () => playSelected());
    pauseBtn.addEventListener('click', pausePlayback);
    resumeBtn.addEventListener('click', resumePlayback);
    seekSlider.addEventListener('input', (event) => {
      const seekTo = Number(event.target.value || 0);
      if (stopCurrent) {
        playSelected(seekTo);
      }
    });

    populateCompositions();
    loadStrudel();
  </script>
</body>
</html>
